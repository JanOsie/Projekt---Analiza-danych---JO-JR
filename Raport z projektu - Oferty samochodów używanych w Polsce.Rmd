# Raport z projektu - Oferty samochodów używanych w Polsce

Julia Rutkowska, Jan Osiecki, Daryna Pyatkevych

## 0. O zbiorze danych

Zbiór danych pozyskany z największego polskiego serwisu z ponad 90 tysięcami ofertami samochodów używanych i nowych otomoto.pl.

-   **marka**: Marka lub producent samochodu, np. Volkswagen, Toyota, BMW, Ford itp.

-   **model**: Model samochodu

-   **cena**: Podana cena samochodu w polskich złotych (PLN), zapewniająca wgląd w trendy cenowe samochodów używanych w Polsce.

-   **przebieg**: Zarejestrowany przebieg samochodu, reprezentujący całkowity dystans przejechany przez pojazd w kilometrach (km).

-   **skrzynia biegów**: Typ skrzyni biegów używanej w samochodzie, oznaczony jako manualna lub automatyczna.

-   **pojemność silnika**: Pojemność silnika lub pojemność skokowa samochodu, mierzona w centymetrach sześciennych (cm3), wskazująca rozmiar silnika.

-   **paliwo**: Rodzaj paliwa używanego przez samochód, w tym opcje takie jak benzyna, olej napędowy, napęd hybrydowy, elektryczny itp.

-   **miasto**: Miasto, w którym samochód jest zlokalizowany lub reklamowany na sprzedaż, oferując wgląd w regionalne różnice w dostępności używanych samochodów.

-   **województwo**: Region administracyjny lub województwo, w którym znajduje się miasto, zapewniające bardziej szczegółowe odniesienie do lokalizacji.

-   **rok**: Rok produkcji samochodu, reprezentujący jego wiek i umożliwiający czasową analizę rynku samochodów używanych.

Analizując ten zbiór danych, naukowcy mogą badać różne aspekty polskiego rynku samochodów używanych, takie jak rozkład cen według marki i modelu, związek między przebiegiem a ceną, popularne rodzaje paliwa i ich dostępność w różnych regionach oraz wpływ wieku samochodu na ceny. Dodatkowo, ten zbiór danych może ułatwić opracowanie modeli predykcyjnych do szacowania wartości używanych samochodów na podstawie ich specyfikacji i historycznych trendów rynkowych.

## 1. Data Wrangling

Po zapoznaniu się z bazą danych przejrzeliśmy ręcznie poszczególne wiersze by zobaczyć strukturę danych. Poza brakującymi wartościami znaleźliśmy wiele wierszy, w których dane były wpisane w złych kolumnach. Zaczeliśmy pracę od uporządkowania tego.

\`\`\`{r} \# pierwsze 10 wartości} XXXXXXXXXXXXX

XXXXXXXXXXXX

```         
```

### 1.1 Identyfikacja wartości błędnych (nie brakujących)

```         

```{r} # przykładowe błędne wartości w kolumnie XXXXXX}
```

```         
wyniki
```

```{r}
# czyszcenie w kolumnie poj_silnika
for (i in 1:nrow(dane16)) {
  # przenieść km do przebiegu, poźniej usunąć
  if (grepl("km", dane16$poj_silnika[i]) & is.na(dane16$przebieg_w_milach[i])) {
    dane16$przebieg_w_milach[i] <- dane16$poj_silnika[i]
    dane16$poj_silnika[i] <- NA
  } 
  # przenieść rok do kol rok, później usunąć
  if (dane16$poj_silnika[i] %in% rok_prawidłowe & is.na(dane16$rok[i])) {
    dane16$rok[i] <- dane16$poj_silnika[i]
    dane16$poj_silnika[i] <- NA
  }
  # jeśli rok już jest to usunąć rok gdy jest w kol poj_silnika
  if (dane16$poj_silnika[i] %in% rok_prawidłowe & !is.na(dane16$rok[i])) {
    dane16$poj_silnika[i] <- NA
  }
  # usuwanie nazw paliw z poj_silnika
  if (dane16$poj_silnika[i] %in% paliwo_prawidlowe) {
    # gdy nie ma wartości w kolumnie paliwo to ją wstaw z kolumy poj_silnika
    if (is.na(dane16$paliwo[i])) {
      dane16$paliwo[i] <- dane16$poj_silnika[i]
      dane16$poj_silnika[i] <- NA
    }
    # gdy w kolumnie paliwo jest paliwo to usuń z kolumny poj_silnika
    if (dane16$paliwo[i] %in% paliwo_prawidlowe) {
      dane16$poj_silnika[i] <- NA
    }
  }
}

# sprawdam jeszcze raz czy coś poza cm3 jest w poj_silnika (pusta tabela)

View(dane16[!grepl("cm3", dane16$poj_silnika) & !is.na(dane16$poj_silnika), ])

```

```         
WYNIK Z VIEW
```

W wyniku "porządkowania" jak powyżej baza danych została z prawidłowymi wartościami bądź brakującymi.

### 1.1 Identyfikacja wartości brakujących

```{r}
# Łączna liczba brakujących wartości
n_miss(dane)
```

```         
[1] 5833
```

```{r}
# Łączna liczba brakujących wartości z podziałem na kolumny
miss_var_summary(dane)
```

```         
# A tibble: 10 × 3
   variable        n_miss pct_miss
   <chr>            <int>    <num>
 1 rok               2730    2.98 
 2 cena_zl           1550    1.69 
 3 poj_silnika       1219    1.33 
 4 przebieg_w_km      334    0.365
 5 marka                0    0    
 6 model                0    0    
 7 skrzynia_biegow      0    0    
 8 paliwo               0    0    
 9 miasto               0    0    
10 wojewodztwo          0    0  
```

```{r}
# wiersze, w których brakuje dana liczba brakujących wartości
dane %>% 
  miss_case_table()
```

```         
# A tibble: 4 × 3
  n_miss_in_case n_cases pct_cases
           <int>   <int>     <dbl>
1              0   86206  94.2    
2              1    4808   5.25   
3              2     502   0.548  
4              3       7   0.00765
```

```{r}
# wykresy zmiennych w których brakuje wartości (malejąco)
vis_miss(dane[, c("rok", "cena_zl", "poj_silnika", "przebieg_w_km")], sort_miss = TRUE, cluster = TRUE)
```

Trzeba dac zdj z clustrem = True

![](http://127.0.0.1:8209/graphics/e3433f11-f9b1-4f78-947d-bcac41b4d135.png)

```{r}
# współwystępowanie NA między zmiennymi
gg_miss_upset(dane[, c("rok", "cena_zl", "poj_silnika", "przebieg_w_km")], 
              nsets = 4)
```

![](http://127.0.0.1:8209/graphics/afc36238-38e5-4633-9f6f-2104cb709a6c.png)

```{r}
# zależność występowania NA miedzy zmiennymi dotyczących ceny a rokiem 
ggplot(data = dane, aes(x = rok, y = cena_zl)) + 
  geom_point() +
  geom_miss_point() +
  scale_color_manual(values = c("red","navyblue")) +
  theme_minimal()
```

![](http://127.0.0.1:8209/graphics/6b1b1ad8-a639-46e9-b05a-22ac1f48b5dd.png)

```{r}
# zależność występowania NA miedzy zmiennymi dotyczących roku a pojemności silnika 
ggplot(data = dane, aes(x = rok, y = poj_silnika)) + 
  geom_point() +
  geom_miss_point() +
  scale_color_manual(values = c("orange","green3")) +
  theme_minimal()
```

![](http://127.0.0.1:8209/graphics/aa999291-70ce-435d-b16a-c12098e8bb29.png)

```{r}
# zależność występowania NA miedzy zmiennymi dotyczących roku a przebiegiem 
ggplot(data = dane, aes(x = rok, y = przebieg_w_km)) + 
  geom_point() +
  geom_miss_point() +
  scale_color_manual(values = c("gold","steelblue1")) +
  theme_minimal()
```

![](http://127.0.0.1:8209/graphics/306613e1-73ac-4ed8-baa5-6f27a7504b2e.png)

```{r}
# zależność występowania NA miedzy zmiennymi dotyczących pojemności silnika a ceną 
ggplot(data = dane, aes(x = poj_silnika, y = cena_zl)) + 
  geom_point() +
  geom_miss_point() +
  scale_color_manual(values = c("lightslateblue","sienna1")) +
  theme_minimal()
```

![](http://127.0.0.1:8209/graphics/99e9a6dc-8333-4762-b969-c202cfba3af1.png)

```{r}
# zależność występowania NA miedzy zmiennymi dotyczących ceny a przebiegu 
ggplot(data = dane, aes(x = cena_zl, y = przebieg_w_km)) + 
  geom_point() +
  geom_miss_point() +
  scale_color_manual(values = c("magenta4","turquoise4")) +
  theme_minimal()
```

![](http://127.0.0.1:8209/graphics/79398abd-7d27-4fbf-8315-9beba2372c69.png)

```{r}
# zależność występowania NA miedzy zmiennymi dotyczących pojemności silnika a przebiegiem 
ggplot(data = dane, aes(x = poj_silnika, y = przebieg_w_km)) + 
  geom_point() +
  geom_miss_point() +
  scale_color_manual(values = c("hotpink3","forestgreen")) +
  theme_minimal()
```

![](http://127.0.0.1:8209/graphics/488a0921-1661-41f8-96d4-cf5af163cc2a.png)

```{r}
# Procentowy udział brakujących wartości w podziale na typ paliwa
gg_miss_var(dane, facet = paliwo, show_pct = TRUE)
```

![](http://127.0.0.1:8209/graphics/e8fcf9b0-64cf-482f-a9c7-1dc970cb34cb.png)

```{r}
# Heatmapa brakujących wartości z podziałem na markę
gg_miss_fct(x = dane, fct = marka)
```

![](http://127.0.0.1:8209/graphics/b73bec89-48d7-4178-96f6-a1ecbfbf8d2b.png)

```{r}
# Heatmapa brakujących wartości z podziałem na rok
gg_miss_fct(x = dane, fct = rok)
```

![](http://127.0.0.1:8209/graphics/31cc5818-d5bb-468a-a07c-29fbc784f953.png)

```{r}
# wykres skumulowana suma brakujących wartości
gg_miss_case_cumsum(dane, breaks = 5000) + theme_bw()
```

![](http://127.0.0.1:8209/graphics/1e169adc-128d-4d35-8bcf-ee8ffa127e53.png)

```{r}
# imputacja metodą KNN - metoda K-najbliższych sąsiadów
dane2 <- dane
dane2_knn <- kNN(dane2)
daneknn <- dane2_knn %>% select(where(~ !is.logical(.)))
n_miss(daneknn)
```
Analiza opisowa 

W celu lepszego zrozumienia danych oraz ich potencjalnego wykorzystania przeprowadziliśmy analizę opisową. 
Dla skutecznego wykorzystania danych, usunęliśmy zbędne spacje z nazw kolumn, zapisaliśmy niektóre kolumny jako wartości numeryczne oraz wybraliśmy biblioteki z których będziemy korzystać dla przeprowadzenia testów statystycznych oraz wizualizacji danych
```{r}
# Usunięcie zbędnych spacji z nazw kolumn
colnames(dane) <- trimws(colnames(dane))

# Konwersja odpowiednich kolumn na wartości numeryczne
dane$poj_silnika <- as.numeric(gsub("[^0-9]", "", dane$poj_silnika))
dane$przebieg_w_km <- as.numeric(gsub("[^0-9]", "", dane$przebieg_w_km))
dane$rok <- as.numeric(dane$rok)

# Ładowanie bibliotek
library(dplyr)
library(ggplot2)
library(ggstatsplot)
library(corrplot)
library(knitr)
```
Pierwszym krokiem naszej analizie jest przedstawienie danych jako tabel liczności

```{r}
# 1. Tabele liczności dla każdej zmiennej
tabele <- list(
  marka = dane %>% count(marka, sort = TRUE),
  model = dane %>% count(model, sort = TRUE),
  wojewodztwo = dane %>% count(wojewodztwo, sort = TRUE),
  rok = dane %>% count(rok, sort = TRUE),
  paliwo = dane %>% count(paliwo, sort = TRUE),
  skrzynia_biegow = dane %>% count(skrzynia_biegow, sort = TRUE),
  poj_silnika = dane %>% count(poj_silnika, sort = TRUE),
  miasto =  dane %>% count(miasto, sort = TRUE)
)

# Wyświetlenie tabel liczności
tabele_md <- lapply(tabele, function(tbl) {
  kable(tbl, format = "markdown", col.names = c("Kategoria", "Liczba"))
})

# Wyświetlenie tabel
names(tabele_md) <- c("Marka", "Model", "Województwo", "Rok", "Paliwo", "Skrzynia biegów", "Pojemność silnika", "Miasto")

for (nazwa in names(tabele_md)) {
  cat(paste0("\n## ", nazwa, "\n\n")) 
  cat(tabele_md[[nazwa]], "\n\n")   
}
```
Na podstawie tabeli liczności, możemy zobaczyć między innymi ilość transakcji w każdym mieście lub województwie, ile zostało przeprowadzonych transakcji z samochodami o danych charakterystykach. 
